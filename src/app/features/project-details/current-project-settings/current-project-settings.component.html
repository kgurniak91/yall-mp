<div class="settings-container">
  <p-message severity="secondary" styleClass="w-full mb-4">
    <span>
      These settings apply only to the current project.
      <br>
      For more options, <a href="#" (click)="openGlobalSettings($event)">visit the global settings</a>.
    </span>
  </p-message>

  <div class="settings-preset-fieldset">
    <p-fieldset legend="Settings Preset" [toggleable]="false">
      <div class="setting-item">
        <p-select id="preset-selector"
                  [options]="settingsPresets()"
                  optionLabel="name"
                  placeholder="Custom"
                  [ngModel]="selectedSettingsPreset()"
                  (ngModelChange)="onSettingsPresetChange($event)">
        </p-select>
      </div>
    </p-fieldset>
  </div>

  <p-fieldset legend="Project-Specific Anki Tags" [toggleable]="false">
    <div class="setting-item-column">
      <app-tags-input [ngModel]="ankiTags()"
                      (ngModelChange)="ankiTagsChange.emit($event)"/>
      <small class="block mt-2">
        Default tags for all cards created from this project.
      </small>
    </div>
  </p-fieldset>

  <p-fieldset legend="Default Subtitles Lookup Action" [toggleable]="false">
    <div class="setting-item-column">
      <div class="flex align-items-center gap-2">
        <p-select [options]="lookupServiceOptions()"
                  [ngModel]="settings().defaultSubtitleLookupServiceId"
                  (ngModelChange)="onSettingChange('defaultSubtitleLookupServiceId', $event)"
                  styleClass="w-full"
                  optionLabel="name"
                  optionValue="id"></p-select>
        <p-button icon="fa-solid fa-rotate-left"
                  (click)="onSettingChange('defaultSubtitleLookupServiceId', null)"
                  [disabled]="settings().defaultSubtitleLookupServiceId === null"
                  pTooltip="Reset to global default"
                  styleClass="p-button-secondary"/>
      </div>
      <small class="block">
        Overrides the default action for a single left-click on a word.
      </small>
    </div>
  </p-fieldset>

  <p-fieldset legend="Subtitles language" [toggleable]="false">
    <div class="setting-item-column">
      <div class="flex align-items-center gap-2">
        <p-select inputId="sub-lang"
                  [options]="subtitlesLanguageOptions"
                  [ngModel]="settings().subtitlesLanguage"
                  (ngModelChange)="onSettingChange('subtitlesLanguage', $event)"
                  styleClass="w-full"
                  optionLabel="label"
                  optionValue="value"></p-select>
        <p-button icon="fa-solid fa-rotate-left"
                  (click)="onSettingChange('subtitlesLanguage', detectedLanguage() || 'other')"
                  [disabled]="!detectedLanguage() || settings().subtitlesLanguage === detectedLanguage()"
                  pTooltip="Reset to auto-detected language"
                  styleClass="p-button-secondary"/>
      </div>
      <small class="block">
        Changes how words are detected in subtitles when hovering.
      </small>
    </div>
  </p-fieldset>

  @if (audioTracks().length > 1) {
    <p-fieldset legend="Audio" [toggleable]="false">
      <div class="setting-item-column">
        <label for="audio" class="font-semibold">
          Audio Track
        </label>
        <p-select inputId="audio"
                  [options]="audioTrackOptions()"
                  [ngModel]="settings().selectedAudioTrackIndex"
                  (ngModelChange)="onAudioTrackChange($event)"
                  styleClass="w-full"
                  optionLabel="label"
                  optionValue="value"></p-select>
      </div>
    </p-fieldset>
  }

  @if (isAssProject()) {
    <p-fieldset legend="Subtitles Renderer" [toggleable]="false">
      <div class="setting-item-column gap-4">
        <div class="flex items-start">
          <p-radioButton name="subtitleRenderer"
                         [value]="false"
                         inputId="renderer-interactive"
                         [ngModel]="settings().useMpvSubtitles"
                         (ngModelChange)="onSettingChange('useMpvSubtitles', $event)"/>
          <label for="renderer-interactive" class="ml-2 cursor-pointer">
            <span class="font-bold block">Interactive (ASS.js)</span>
            <span class="text-sm">Allows word selection and manual editing of subtitles but may have rendering issues with complex styles.</span>
          </label>
        </div>

        <div class="flex items-start">
          <p-radioButton name="subtitleRenderer"
                         [value]="true"
                         inputId="renderer-mpv"
                         [ngModel]="settings().useMpvSubtitles"
                         (ngModelChange)="onSettingChange('useMpvSubtitles', $event)"/>
          <label for="renderer-mpv" class="ml-2 cursor-pointer">
            <span class="font-bold block">Pixel-Perfect (MPV)</span>
            <span class="text-sm">A high-precision, non-interactive preview of the original subtitles. Does not show manual edits.</span>
          </label>
        </div>
      </div>

      @if (!settings().useMpvSubtitles) {
        <p-divider/>
        <div class="setting-item-column">
          <label for="ass-scale-percentage" class="font-bold">Rendering Scale</label>
          <div class="flex align-items-center gap-2">
            <p-inputNumber inputId="ass-scale-percentage"
                           [ngModel]="settings().assScalePercentage"
                           (ngModelChange)="onSettingChange('assScalePercentage', $event)"
                           suffix=" %"
                           mode="decimal"
                           [minFractionDigits]="2"
                           [maxFractionDigits]="2"
                           [step]="1.00"
                           [showButtons]="true"/>
            <p-button icon="fa-solid fa-rotate-left"
                      (click)="onSettingChange('assScalePercentage', 100.00)"
                      [disabled]="settings().assScalePercentage === 100.00"
                      pTooltip="Reset to default (100%)"
                      styleClass="p-button-secondary"/>
          </div>
          <small class="block">
            Adjust if subtitles are the wrong size or are cut off.
          </small>
        </div>
      }
    </p-fieldset>
  }

  <app-common-project-settings [settings]="settings()"
                               (settingsChange)="settingsChange.emit($event)"/>
</div>
