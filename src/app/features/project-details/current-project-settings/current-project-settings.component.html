<div class="settings-container">
  <p-message severity="secondary" styleClass="w-full mb-4">
    <span>
      These settings apply only to the current project.
      <br>
      For more options, <a href="#" (click)="openGlobalSettings($event)">visit the global settings</a>.
    </span>
  </p-message>

  <div class="settings-preset-fieldset">
    <p-fieldset legend="Settings Preset" [toggleable]="false">
      <div class="setting-item">
        <p-select id="preset-selector"
                  [options]="settingsPresets()"
                  styleClass="w-full"
                  optionLabel="name"
                  placeholder="Custom"
                  appendTo="body"
                  [ngModel]="selectedSettingsPreset()"
                  (ngModelChange)="onSettingsPresetChange($event)">
        </p-select>
      </div>

      @if (selectedSettingsPreset(); as preset) {
        <p-message severity="secondary" styleClass="w-full">
          <div class="p-0 m-0 font-normal line-height-3">
            @if (preset.id === BuiltInSettingsPreset.LISTENING) {
              <p class="mt-0 mb-2">
                Clips play without subtitles and pause automatically at the end.
                <br><br>
                <strong>Goal:</strong> Listen and figure out what was said.
              </p>
              <ul class="pl-3 m-0 mb-2">
                <li>
                  Not sure? Press <b>↑</b> to replay the audio.
                </li>
                <li>
                  Ready? Press <b>C</b> to reveal subtitles and check your answer.
                </li>
              </ul>
            } @else if (preset.id === BuiltInSettingsPreset.SPEAKING) {
              <p class="mt-0 mb-2">
                Clips start paused automatically and with subtitles visible.
                <br><br>
                <strong>Goal:</strong> Read the subtitles out loud and practice your pronunciation.
              </p>
              <ul class="pl-3 m-0 mb-2">
                <li>
                  Press <b>Spacebar</b> to hear the native audio and compare it with your speech.
                </li>
                <li>
                  The clip automatically pauses at the end so you can press <b>↑</b> to replay and perfect your accent.
                </li>
              </ul>
            }
            <p class="m-0 p-0">
              To move to the next clip, press <b>Spacebar</b> (unpause) or <b>↓</b> (force continue).
            </p>
          </div>
        </p-message>
      }
    </p-fieldset>
  </div>

  <p-fieldset legend="Project-Specific Anki Tags" [toggleable]="false">
    <div class="setting-item-column">
      <app-tags-input [ngModel]="ankiTags()"
                      (ngModelChange)="ankiTagsChange.emit($event)"/>
      <small class="block mt-2">
        Default tags for all cards created from this project.
      </small>
    </div>
  </p-fieldset>

  <p-fieldset legend="Default Online Lookup Action" [toggleable]="false">
    <div class="setting-item-column">
      <div class="flex align-items-center gap-2">
        <p-select [options]="lookupServiceOptions()"
                  [ngModel]="settings().defaultSubtitleLookupServiceId"
                  (ngModelChange)="onSettingChange('defaultSubtitleLookupServiceId', $event)"
                  styleClass="w-full"
                  optionLabel="name"
                  appendTo="body"
                  optionValue="id"></p-select>
        <p-button icon="fa-solid fa-rotate-left"
                  (click)="onSettingChange('defaultSubtitleLookupServiceId', null)"
                  [disabled]="settings().defaultSubtitleLookupServiceId === null"
                  pTooltip="Reset to global default"
                  styleClass="p-button-secondary"/>
      </div>
      <small class="block">
        Overrides the default action for a single left-click on a word.
      </small>
    </div>
  </p-fieldset>

  <p-fieldset legend="Subtitles Language Detection" [toggleable]="false">
    <div class="setting-item-column">
      <small class="block">
        This option changes how words are detected in subtitles when hovering over them with a mouse cursor
        and enables <a href="#" (click)="openOfflineDictSettings($event)">offline dictionary</a> lookups (if configured).
      </small>
      <div class="flex align-items-center gap-2">
        <p-select inputId="sub-lang"
                  [options]="subtitlesLanguageOptions()"
                  [ngModel]="settings().subtitlesLanguage"
                  (ngModelChange)="onSettingChange('subtitlesLanguage', $event)"
                  [virtualScroll]="true"
                  [virtualScrollItemSize]="36"
                  styleClass="w-full"
                  optionLabel="label"
                  optionValue="value"
                  [filter]="true"
                  filterBy="label"
                  placeholder="Select language..."
                  appendTo="body">
        </p-select>
        <p-button icon="fa-solid fa-rotate-left"
                  (click)="onSettingChange('subtitlesLanguage', detectedLanguage() || 'other')"
                  [disabled]="!detectedLanguage() || settings().subtitlesLanguage === detectedLanguage()"
                  pTooltip="Reset to auto-detected language"
                  styleClass="p-button-secondary"/>
      </div>
      <small class="block">
        If you want to change the language of the subtitles, you need to go to the main menu and select "Edit current project".
      </small>
    </div>
  </p-fieldset>

  @if (isAssProject()) {
    <p-fieldset legend="Subtitles Renderer" [toggleable]="false">
      <div class="setting-item-column gap-4">
        <div class="flex items-start">
          <p-radioButton name="subtitleRenderer"
                         [value]="false"
                         inputId="renderer-interactive"
                         [ngModel]="settings().useMpvSubtitles"
                         (ngModelChange)="onSettingChange('useMpvSubtitles', $event)"/>
          <label for="renderer-interactive" class="ml-2 cursor-pointer">
            <span class="font-bold block">Interactive (ASS.js)</span>
            <span class="text-sm">Allows word selection and manual editing of subtitles but may have rendering issues with complex styles.</span>
          </label>
        </div>

        <div class="flex items-start">
          <p-radioButton name="subtitleRenderer"
                         [value]="true"
                         inputId="renderer-mpv"
                         [ngModel]="settings().useMpvSubtitles"
                         (ngModelChange)="onSettingChange('useMpvSubtitles', $event)"/>
          <label for="renderer-mpv" class="ml-2 cursor-pointer">
            <span class="font-bold block">Pixel-Perfect (MPV)</span>
            <span class="text-sm">A high-precision, non-interactive preview of the original subtitles. Does not show manual edits.</span>
          </label>
        </div>
      </div>

      @if (!settings().useMpvSubtitles) {
        <p-divider/>
        <div class="setting-item-column">
          <label for="ass-scale-percentage" class="font-bold">Rendering Scale</label>
          <div class="flex align-items-center gap-2">
            <p-inputNumber inputId="ass-scale-percentage"
                           [ngModel]="settings().assScalePercentage"
                           (ngModelChange)="onSettingChange('assScalePercentage', $event)"
                           suffix=" %"
                           mode="decimal"
                           [minFractionDigits]="2"
                           [maxFractionDigits]="2"
                           [step]="1.00"
                           [showButtons]="true"/>
            <p-button icon="fa-solid fa-rotate-left"
                      (click)="onSettingChange('assScalePercentage', 100.00)"
                      [disabled]="settings().assScalePercentage === 100.00"
                      pTooltip="Reset to default (100%)"
                      styleClass="p-button-secondary"/>
          </div>
          <small class="block">
            Adjust if subtitles are the wrong size or are cut off.
          </small>
        </div>
      }
    </p-fieldset>
  }

  <app-common-project-settings [settings]="settings()"
                               (settingsChange)="settingsChange.emit($event)"/>
</div>
